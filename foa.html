<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Editable Finance Chart</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
    }
    input[type="file"] {
      display: block;
      margin: 1rem auto;
    }
    canvas {
      background: white;
      border: 1px solid #ccc;
      display: block;
      margin: 2rem auto;
    }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
      width: 90%;
      margin: 1rem auto;
      border: 1px solid #ccc;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background: #eee;
    }
    td[contenteditable] {
      background-color: #fffbe7;
    }
    .delete-btn {
      color: red;
      cursor: pointer;
    }
    select.type-select {
      width: 100%;
    }
    .income-cell { background-color: #e0ffe0; }
    .expense-cell { background-color: #ffe0e0; }
    .reserve-cell { background-color: #e0e0ff; }
  </style>
</head>
<body>
  <h1>Multi-Month Finance Editor</h1>
  <div class="controls">
    <button onclick="addRow()">Add Row</button>
    <button onclick="updateChart()">Update Chart</button>
    <button onclick="exportCSV()">Export CSV</button>
    <input type="file" id="csvUpload" accept=".csv">
  </div>  <div class="table-container">
    <table id="financeTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Month (YYYY-MM)</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div><canvas id="mainChart" width="800" height="300"></canvas> <canvas id="netChart" width="800" height="200"></canvas> <canvas id="cumulativeChart" width="800" height="200"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <script>
    let mainChart, netChart, cumulativeChart;

    const initialData = [
      ["Income", "2025-06", "Salary", 5000],
      ["Expenditure", "2025-06", "Rent", 1200],
      ["Expenditure", "2025-06", "Groceries", 320],
      ["Income", "2025-07", "Salary", 5200],
      ["Expenditure", "2025-07", "Rent", 1200],
      ["Expenditure", "2025-07", "Utilities", 350],
      ["Reserve", "2025-06", "Opening", 2000]
    ];

    function createRow([type, month, category, amount]) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><select class="type-select">
          <option value="Income" ${type === 'Income' ? 'selected' : ''}>Income</option>
          <option value="Expenditure" ${type === 'Expenditure' ? 'selected' : ''}>Expenditure</option>
          <option value="Reserve" ${type === 'Reserve' ? 'selected' : ''}>Reserve</option>
        </select></td>
        <td contenteditable>${month}</td>
        <td contenteditable>${category}</td>
        <td contenteditable>${amount}</td>
        <td><span class="delete-btn" onclick="deleteRow(this)">&#10060;</span></td>
      `;
      document.querySelector('#financeTable tbody').appendChild(tr);
    }

    function getDataFromTable() {
      const rows = document.querySelectorAll('#financeTable tbody tr');
      const data = [];
      rows.forEach(row => {
        const type = row.querySelector('select').value;
        const cells = row.querySelectorAll('td');
        const month = cells[1].innerText.trim();
        const category = cells[2].innerText.trim();
        const amount = parseFloat(cells[3].innerText.trim());
        if (month && category && !isNaN(amount)) {
          data.push({ type, month, category, amount });
        }
      });
      return data;
    }

    function groupData(data) {
      const grouped = {}, net = {}, cumulative = {}, reserves = {};
      const months = new Set(), categories = new Set();

      data.forEach(item => {
        months.add(item.month);
        categories.add(item.category);
        if (item.type === 'Reserve') {
          reserves[item.month] = (reserves[item.month] || 0) + item.amount;
        } else {
          if (!grouped[item.month]) grouped[item.month] = {};
          grouped[item.month][item.category] = (grouped[item.month][item.category] || 0) + (item.type === 'Expenditure' ? -Math.abs(item.amount) : Math.abs(item.amount));
          net[item.month] = (net[item.month] || 0) + (item.type === 'Expenditure' ? -Math.abs(item.amount) : Math.abs(item.amount));
        }
      });

      let sortedMonths = Array.from(months).sort();
      const allMonths = [...sortedMonths];
      const last = sortedMonths.slice(-1);
      if (last.length === 1) {
        const lastNet = net[last[0]] || 0;
        const next1 = nextMonthStr(last[0]);
        const next2 = nextMonthStr(next1);
        net[next1] = lastNet;
        net[next2] = lastNet;
        allMonths.push(next1, next2);
      }

      let cumSum = 0;
      for (let m of allMonths) {
        if (reserves[m]) cumSum = reserves[m];
        cumSum += net[m] || 0;
        cumulative[m] = cumSum;
      }

      return {
        grouped,
        net,
        cumulative,
        months: allMonths,
        categories: Array.from(categories),
        lastRealMonth: sortedMonths.at(-1)
      };
    }

    function nextMonthStr(monthStr) {
      const [y, m] = monthStr.split('-').map(Number);
      const date = new Date(y, m, 1);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }

    function updateChart() {
      const rawData = getDataFromTable();
      const { grouped, net, cumulative, months, categories, lastRealMonth } = groupData(rawData);

      const mainDatasets = months.filter(m => m <= lastRealMonth).map(month => ({
        label: month,
        data: categories.map(cat => (grouped[month]?.[cat] || 0)),
        fill: false,
        tension: 0.1
      }));

      const netData = months.map(m => net[m] || 0);
      const cumulativeData = months.map(m => cumulative[m] || 0);
      const isProjected = months.map(m => m > lastRealMonth);

      if (mainChart) mainChart.destroy();
      if (netChart) netChart.destroy();
      if (cumulativeChart) cumulativeChart.destroy();

      mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: categories,
          datasets: mainDatasets
        },
        options: {
          plugins: { title: { display: true, text: 'Monthly Finance by Category' } }
        }
      });

      netChart = new Chart(document.getElementById('netChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly Net',
            data: netData,
            backgroundColor: netData.map((val, i) => isProjected[i] ? '#cccccc' : (val >= 0 ? '#a0e0a0' : '#e0a0a0'))
          }]
        },
        options: {
          plugins: { title: { display: true, text: 'Net Position per Month' } }
        }
      });

      const actualCumulative = {
        label: 'Cumulative Net (Actual)',
        data: cumulativeData.map((v, i) => isProjected[i] ? null : v),
        borderColor: '#333',
        fill: false,
        borderDash: []
      };
      const projectedCumulative = {
        label: 'Cumulative Net (Projected)',
        data: cumulativeData.map((v, i) => isProjected[i] ? v : null),
        borderColor: '#666',
        fill: false,
        borderDash: [5, 5]
      };

      cumulativeChart = new Chart(document.getElementById('cumulativeChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: months,
          datasets: [actualCumulative, projectedCumulative]
        },
        options: {
          plugins: { title: { display: true, text: 'Cumulative Net with Projections' } }
        }
      });
    }

    function addRow() {
      createRow(["Income", "2025-08", "New Category", 0]);
    }

    function deleteRow(btn) {
      btn.closest('tr').remove();
    }

    function exportCSV() {
      const data = getDataFromTable();
      const csv = ['Type,Month,Category,Amount'];
      data.forEach(row => {
        csv.push(`${row.type},${row.month},${row.category},${row.amount}`);
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'finance_data.csv';
      link.click();
    }

    document.getElementById('csvUpload').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const lines = event.target.result.trim().split('\n');
        document.querySelector('#financeTable tbody').innerHTML = '';
        lines.slice(1).forEach(line => {
          const [type, month, category, amount] = line.split(',');
          createRow([type, month, category, amount]);
        });
        updateChart();
      };
      reader.readAsText(file);
    });

    initialData.forEach(createRow);
    updateChart();
  </script></body>
</html>
